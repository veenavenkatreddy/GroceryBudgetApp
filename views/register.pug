doctype html
html(lang='en')
  head
    meta(charset='UTF-8')
    meta(name='viewport' content='width=device-width, initial-scale=1.0')
    meta(name='description' content='Sign up for CartWise - Shop Smart, Save More')
    title Sign Up - CartWise
    
    // Bootstrap CSS
    link(href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css' rel='stylesheet')
    link(href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css' rel='stylesheet')
    
    // Google Fonts
    link(rel='preconnect' href='https://fonts.googleapis.com')
    link(rel='preconnect' href='https://fonts.gstatic.com' crossorigin)
    link(href='https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap' rel='stylesheet')
    
    // Custom CSS
    link(rel='stylesheet' href='/css/auth.css')
  
  body
    .auth-wrapper.d-flex.align-items-center.justify-content-center.min-vh-100
      .auth-container.w-100.px-3(style='max-width: 420px;')
        .auth-card.p-4.shadow-sm.rounded
          .text-center.mb-4
            a.navbar-brand(href='/')
              i.bi.bi-cart3.me-2.text-primary(style='font-size: 2rem;')
              h2.fw-bold.mb-0 CartWise
            p.text-muted.mt-2 Create your free account and start budgeting
          
          if error
            .alert.alert-danger.d-flex.align-items-center(role='alert')
              i.bi.bi-exclamation-circle.me-2
              div= error
          
          if success
            .alert.alert-success.d-flex.align-items-center(role='alert')
              i.bi.bi-check-circle.me-2
              div= success
          
          form#registerForm.needs-validation(novalidate)
            .form-floating.mb-3.position-relative
              input.form-control#username(type='text' placeholder='Username' required pattern='[a-zA-Z0-9_]{3,20}' title='3-20 characters, letters, numbers, and underscores only')
              label(for='username') Username
              .form-icon.position-absolute.top-50.end-0.translate-middle-y.pe-3
                i.bi.bi-person
              .invalid-feedback Please enter a valid username (3â€“20 letters, numbers, or underscores).
            
            .form-floating.mb-3.position-relative
              input.form-control#email(type='email' placeholder='Email' required)
              label(for='email') Email address
              .form-icon.position-absolute.top-50.end-0.translate-middle-y.pe-3
                i.bi.bi-envelope
              .invalid-feedback Please enter a valid email address.
            
            .form-floating.mb-3.position-relative
              input.form-control#password(type='password' placeholder='Password' required minlength='6')
              label(for='password') Password
              .form-icon.position-absolute.top-50.end-0.translate-middle-y.pe-5
                i.bi.bi-lock
              button.btn.btn-link.password-toggle#togglePassword(type='button' tabindex='-1')
                i.bi.bi-eye
              .invalid-feedback Please enter a password of at least 6 characters.
            .password-strength
              .password-strength-bar#passwordStrength
            .small.text-dark.mt-1 Use 6+ characters with a mix of letters & numbers
            
            .form-check.mb-4.mt-3
              input.form-check-input#terms(type='checkbox' required)
              label.form-check-label(for='terms')
                | I agree to the 
                a(href='#' data-bs-toggle='modal' data-bs-target='#termsModal') Terms of Service
                |  and 
                a(href='#' data-bs-toggle='modal' data-bs-target='#privacyModal') Privacy Policy
              .invalid-feedback You must agree to the terms and privacy policy.
            
            .d-grid.gap-3
              button.btn.btn-primary.btn-lg(type='submit')
                | Create Account
                i.bi.bi-arrow-right.ms-2
          
          .text-center.mt-4
            p.mb-0.text-muted
              | Already have an account? 
              a.text-primary.text-decoration-none.fw-semibold(href='/login') Sign in
    
    // Terms Modal
    .modal.fade#termsModal(tabindex='-1')
      .modal-dialog.modal-dialog-scrollable
        .modal-content
          .modal-header
            h5.modal-title Terms of Service
            button.btn-close(type='button' data-bs-dismiss='modal')
          .modal-body
            h6 1. Acceptance of Terms
            p By using CartWise, you agree to these terms.
            h6 2. Educational Purpose
            p This app is for educational budgeting purposes only.
            h6 3. Data Privacy
            p We protect your data according to GDPR standards.
            h6 4. User Responsibilities
            p You are responsible for securing your account.
            h6 5. Limitation of Liability
            p Provided "as is" without warranties.
          .modal-footer
            button.btn.btn-secondary(type='button' data-bs-dismiss='modal') Close
    
    // Privacy Modal
    .modal.fade#privacyModal(tabindex='-1')
      .modal-dialog.modal-dialog-scrollable
        .modal-content
          .modal-header
            h5.modal-title Privacy Policy
            button.btn-close(type='button' data-bs-dismiss='modal')
          .modal-body
            h6 1. Information We Collect
            p We collect your username, email, and password to create your account.
            h6 2. How We Use It
            p Your data is only used to provide and improve our services.
            h6 3. Data Security
            p Protected with encryption and secure servers.
            h6 4. Your Rights
            p You may update or delete your account at any time.
          .modal-footer
            button.btn.btn-secondary(type='button' data-bs-dismiss='modal') Close
    
    // Bootstrap JS
    script(src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js')
    
    // Custom JS
    script.
      // Bootstrap validation
      (() => {
        'use strict';
        const form = document.getElementById('registerForm');
        form.addEventListener('submit', async e => {
          e.preventDefault();
          if (!form.checkValidity()) {
            e.stopPropagation();
            form.classList.add('was-validated');
            return;
          }
          const btn = form.querySelector('button[type="submit"]');
          const original = btn.innerHTML;
          btn.disabled = true;
          btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating account...';
          const payload = {
            username: document.getElementById('username').value.trim(),
            email: document.getElementById('email').value.trim(),
            password: document.getElementById('password').value
          };
          try {
            const res = await fetch('/api/auth/register', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (data.success) {
              showAlert('success', 'Account created! Redirecting...');
              setTimeout(() => window.location.href = '/login', 2000);
            } else {
              showAlert('danger', data.message || 'Registration failed.');
            }
          } catch {
            showAlert('danger', 'An error occurred. Please try again.');
          } finally {
            btn.disabled = false;
            btn.innerHTML = original;
          }
        });
      })();

      // Toggle password visibility
      document.getElementById('togglePassword').addEventListener('click', function() {
        const input = document.getElementById('password');
        const icon = this.querySelector('i');
        if (input.type === 'password') {
          input.type = 'text';
          icon.classList.replace('bi-eye', 'bi-eye-slash');
        } else {
          input.type = 'password';
          icon.classList.replace('bi-eye-slash', 'bi-eye');
        }
      });

      // Password strength
      document.getElementById('password').addEventListener('input', e => {
        const pass = e.target.value;
        const bar = document.getElementById('passwordStrength');
        let score = 0;
        if (pass.length >= 6) score++;
        if (pass.length >= 8) score++;
        if (/[A-Z]/.test(pass) && /[a-z]/.test(pass)) score++;
        if (/[0-9]/.test(pass)) score++;
        if (/[^A-Za-z0-9]/.test(pass)) score++;
        bar.className = 'password-strength-bar';
        if (score > 0) bar.classList.add(score <= 2 ? 'password-strength-weak' : score <= 4 ? 'password-strength-medium' : 'password-strength-strong');
      });

      // Alert helper
      function showAlert(type, message) {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible d-flex align-items-center mt-3`;
        alert.innerHTML = `
          <i class="bi bi-${type === 'danger' ? 'exclamation-circle' : 'check-circle'} me-2"></i>
          <div>${message}</div>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        const existing = document.querySelector('.auth-card .alert');
        if (existing) existing.remove();
        document.querySelector('.auth-card').prepend(alert);
      }
